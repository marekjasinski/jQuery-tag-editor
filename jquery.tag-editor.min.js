/*
	jQuery tagEditor v1.0.18 modified by Marek Jasinski
    Copyright (c) 2014 Simon Steinberger / Pixabay
    GitHub: https://github.com/Pixabay/jQuery-tagEditor
	License: http://www.opensource.org/licenses/mit-license.php
*/
!function(a){a.fn.tagEditorInput=function(){var b=" ",c=a(this),d=parseInt(c.css("fontSize")),e=a("<span/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:c.css("fontSize"),fontFamily:c.css("fontFamily"),fontWeight:c.css("fontWeight"),letterSpacing:c.css("letterSpacing"),whiteSpace:"nowrap"}),f=function(){if(b!==(b=c.val())){e.html(b.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var a=e.width()+d;20>a&&(a=20),a!=c.width()&&c.width(a)}};return e.insertAfter(c),c.bind("keyup keydown focus",f)},a.fn.tagEditor=function(b,c,d){function e(a){return a.replace(/"/g,"'").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function f(a){return{}.toString.call(a).match(/\s([a-zA-Z]+)/)[1].toLowerCase()}function g(a){switch(a=a.toLowerCase(),a.substr(0,1)){case"-":a=a.substring(1);break;case"@":a=a.substring(1);break;case"$":a="#"===a.substr(1,1)?a.substring(2):a.substring(1);break;case"#":var b=a.substr(1,3),c=b.match("(vj:|vc:|vd:)");"null"!==f(c)&&(a=a.substring(4))}return a}function h(a){switch(a=a.toLowerCase(),a.substr(0,1)){case"-":a="fa-minus-circle";break;case"@":a="fa-at";break;case"$":a="#"===a.substr(1,1)?"fa-globe":"fa-user";break;case"#":var b=a.substr(1,3);a="vj:"===b?"visual vj":"vc:"===b?"visual vc":"vd:"===b?"visual vd":"";break;default:a=""}return a}function n(b){if(8==b.which||46==b.which||b.ctrlKey&&88==b.which){try{var c=getSelection(),d=a(c.getRangeAt(0).commonAncestorContainer)}catch(b){d=0}if(d&&d.hasClass("tag-editor")){var e=[],f=c.toString().split(d.prev().data("options").dregex);for(i=0;i<f.length;i++){var g=a.trim(f[i]);g&&e.push(g)}return a(".tag-editor-tag",d).each(function(){~a.inArray(a(this).text(),e)&&a(this).closest("li").find(".tag-editor-delete").click()}),!1}}}var j,k=a.extend({},a.fn.tagEditor.defaults,b),l=this;if(k.dregex=new RegExp("["+k.delimiter.replace("-","-")+"]","g"),"string"==typeof b){var m=[];return l.each(function(){var e=a(this),f=e.data("options"),g=e.next(".tag-editor");if("getTags"==b)m.push({field:e[0],editor:g,tags:g.data("tags")});else if("addTag"==b){if(f.maxTags&&g.data("tags").length>=f.maxTags)return!1;a('<li><div class="tag-editor-spacer">&nbsp;'+f.delimiter[0]+'</div><span class="origin-tag hidden"></span><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(g).find(".tag-editor-tag").html('<input type="text" maxlength="'+f.maxLength+'">').addClass("active").find("input").val(c).blur(),d?a(".placeholder",g).remove():g.click()}else"removeTag"==b?(a(".tag-editor-tag",g).filter(function(){return a(this).parent().find(".origin-tag").text()==c}).closest("li").find(".tag-editor-delete").click(),d||g.click()):"destroy"==b&&e.removeClass("tag-editor-hidden-src").removeData("options").off("focus.tag-editor").next(".tag-editor").remove()}),"getTags"==b?m:this}return window.getSelection&&a(document).off("keydown.tag-editor").on("keydown.tag-editor",n),l.each(function(){function i(){k.placeholder&&!a(".deleted, .placeholder, input",d).length&&d.append('<li class="placeholder"><div>'+k.placeholder+"</div></li>")}function l(e){var f=c.toString();c=a(".tag-editor-tag:not(.deleted)",d).map(function(b,c){var d=a.trim(a(this).hasClass("active")?a(this).find("input").val():a(c).parent().find(".origin-tag").text());return d?d:void 0}).get(),d.data("tags",c),b.val(c.join(k.delimiter[0])),e||f!=c.toString()&&k.onChange(b,d,c),i()}function m(f){for(var p,i=f.closest("li"),j=f.val().replace(/ +/," ").split(k.dregex),m=f.data("old_tag"),n=c.slice(0),o=!1,q=0;q<j.length;q++)if(r=a.trim(j[q]).slice(0,k.maxLength),k.forceLowercase&&(r=r.toLowerCase()),p=k.beforeTagSave(b,d,n,m,r),r=p||r,p!==!1&&r&&(k.removeDuplicates&&~a.inArray(r,n)&&a(".tag-editor-tag",d).each(function(){a(this).text()==r&&a(this).closest("li").remove()}),n.push(r),i.before('<li><div class="tag-editor-spacer">&nbsp;'+k.delimiter[0]+'</div><span class="origin-tag hidden">'+e(r)+'</span><div class="tag-editor-tag"><i class="fa '+h(e(r))+'"></i>'+g(e(r))+'</div><div class="tag-editor-delete"><i></i></div></li>'),k.maxTags&&n.length>=k.maxTags)){o=!0;break}f.attr("maxlength",k.maxLength).removeData("old_tag").val(""),o?f.blur():f.focus(),l()}var b=a(this),c=[],d=a("<ul "+(k.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(b);b.addClass("tag-editor-hidden-src").data("options",k).on("focus.tag-editor",function(){d.click()}),d.append('<li style="width:1px">&nbsp;</li>');var f='<li><div class="tag-editor-spacer">&nbsp;'+k.delimiter[0]+'</div><span class="origin-tag hidden"></span><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';d.click(function(b,c){var e,h,g=99999;if(!window.getSelection||""==getSelection())return k.maxTags&&d.data("tags").length>=k.maxTags?(d.find("input").blur(),!1):(j=!0,a("input:focus",d).blur(),j?(j=!0,a(".placeholder",d).remove(),c&&c.length?h="before":a(".tag-editor-tag",d).each(function(){var d=a(this),f=d.offset(),i=f.left,j=f.top;b.pageY>=j&&b.pageY<=j+d.height()&&(b.pageX<i?(h="before",e=i-b.pageX):(h="after",e=b.pageX-i-d.width()),g>e&&(g=e,c=d))}),"before"==h?a(f).insertBefore(c.closest("li")).find(".tag-editor-tag").click():"after"==h?a(f).insertAfter(c.closest("li")).find(".tag-editor-tag").click():a(f).appendTo(d).find(".tag-editor-tag").click(),!1):!1)}),d.on("click",".tag-editor-delete",function(e){if(a(this).prev().hasClass("active"))return a(this).closest("li").find("input").caret(-1),!1;var f=a(this).closest("li"),g=f.find(".tag-editor-tag");return k.beforeTagDelete(b,d,c,g.text())===!1?!1:(g.addClass("deleted").animate({width:0},k.animateDelete,function(){f.remove(),i(),k.afterTagDelete(b,d,c,g.text())}),l(),!1)}),k.clickDelete&&d.on("mousedown",".tag-editor-tag",function(e){if(e.ctrlKey||e.which>1){var f=a(this).closest("li"),g=f.find(".tag-editor-tag");return k.beforeTagDelete(b,d,c,g.text())===!1?!1:(g.addClass("deleted").animate({width:0},k.animateDelete,function(){f.remove(),i()}),l(),!1)}}),d.on("click",".tag-editor-tag",function(b){if(k.clickDelete&&(b.ctrlKey||b.which>1))return!1;if(!a(this).hasClass("active")){var c=a(this).html(),e=a(this).parent().find(".origin-tag").text();e||(e="");var f=Math.abs((a(this).offset().left-b.pageX)/a(this).width()),g=parseInt(c.length*f),h=a(this).html('<input type="text" maxlength="'+k.maxLength+'" value="'+e+'">').addClass("active").find("input");if(h.data("old_tag",e).tagEditorInput().focus().caret(g),k.autocomplete){var i=a.extend({},k.autocomplete),j="select"in i?k.autocomplete.select:"";i.select=function(b,c){j&&j(b,c),setTimeout(function(){d.trigger("click",[a(".active",d).find("input").closest("li").next("li").find(".tag-editor-tag")])},20)},h.autocomplete(i)}}return!1}),d.on("blur","input",function(f){f.stopPropagation();var n=a(this),o=n.data("old_tag"),p=a.trim(n.val().replace(/ +/," ").replace(k.dregex,k.delimiter[0]));if(p){if(p.indexOf(k.delimiter[0])>=0)return void m(n);if(p!=o)if(k.forceLowercase&&(p=p.toLowerCase()),cb_val=k.beforeTagSave(b,d,c,o,p),p=cb_val||p,cb_val===!1){if(o)return n.val(o).focus(),j=!1,void l();try{n.closest("li").remove()}catch(f){}o&&l()}else k.removeDuplicates&&a(".tag-editor-tag:not(.active)",d).each(function(){a(this).parent().find(".origin-tag").text()==p&&a(this).closest("li").remove()})}else{if(o&&k.beforeTagDelete(b,d,c,o)===!1)return n.val(o).focus(),j=!1,void l();try{n.closest("li").remove()}catch(f){}o&&l()}n.parent().text(g(e(p))).parent().find(".origin-tag").text(e(p)).parent().find(".tag-editor-tag").removeClass("active").prepend('<i class="fa '+h(e(p))+'"></i>'),p!=o&&l(),i()});var n;d.on("paste","input",function(b){a(this).removeAttr("maxlength"),n=a(this),setTimeout(function(){m(n)},30)});var o;d.on("keypress","input",function(b){k.delimiter.indexOf(String.fromCharCode(b.which))>=0&&(o=a(this),setTimeout(function(){m(o)},20))}),d.on("keydown","input",function(c){var e=a(this);if((37==c.which||!k.autocomplete&&38==c.which)&&!e.caret()||8==c.which&&!e.val()){var g=e.closest("li").prev("li").find(".tag-editor-tag");return g.length?g.click().find("input").caret(-1):!e.val()||k.maxTags&&d.data("tags").length>=k.maxTags||a(f).insertBefore(e.closest("li")).find(".tag-editor-tag").click(),!1}if((39==c.which||!k.autocomplete&&40==c.which)&&e.caret()==e.val().length){var h=e.closest("li").next("li").find(".tag-editor-tag");return h.length?h.click().find("input").caret(0):e.val()&&d.click(),!1}if(9==c.which){if(c.shiftKey){var g=e.closest("li").prev("li").find(".tag-editor-tag");if(g.length)g.click().find("input").caret(0);else{if(!e.val()||k.maxTags&&d.data("tags").length>=k.maxTags)return b.attr("disabled","disabled"),void setTimeout(function(){b.removeAttr("disabled")},30);a(f).insertBefore(e.closest("li")).find(".tag-editor-tag").click()}return!1}var h=e.closest("li").next("li").find(".tag-editor-tag");if(h.length)h.click().find("input").caret(0);else{if(!e.val())return;d.click()}return!1}if(!(46!=c.which||a.trim(e.val())&&e.caret()!=e.val().length)){var h=e.closest("li").next("li").find(".tag-editor-tag");return h.length?h.click().find("input").caret(0):e.val()&&d.click(),!1}if(13==c.which)return d.trigger("click",[e.closest("li").next("li").find(".tag-editor-tag")]),k.afterClickEnter(),!1;if(36!=c.which||e.caret()){if(35==c.which&&e.caret()==e.val().length)d.find(".tag-editor-tag").last().click();else if(27==c.which)return e.val(e.data("old_tag")?e.data("old_tag"):"").blur(),!1}else d.find(".tag-editor-tag").first().click()});for(var p=k.initialTags.length?k.initialTags:b.val().split(k.dregex),q=0;q<p.length&&!(k.maxTags&&q>=k.maxTags);q++){var r=a.trim(p[q].replace(/ +/," "));r&&(k.forceLowercase&&(r=r.toLowerCase()),c.push(r),d.append('<li><div class="tag-editor-spacer">&nbsp;'+k.delimiter[0]+'</div><span class="origin-tag hidden">'+e(r)+'</span><div class="tag-editor-tag"><i class="fa '+h(e(r))+'"></i>'+g(e(r))+'</div><div class="tag-editor-delete"><i></i></div></li>'))}l(!0),k.sortable&&a.fn.sortable&&d.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){l()}})})},a.fn.tagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,removeDuplicates:!0,clickDelete:!1,animateDelete:175,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){},afterTagDelete:function(){},afterClickEnter:function(){}}}(jQuery);